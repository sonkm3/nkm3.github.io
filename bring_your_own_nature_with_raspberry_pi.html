<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Raspberry Piで自然を手元に持ってくる方法について
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <meta property="og:site_name" content="nkm3" />
                <meta property="og:type" content="article" />
                <meta property="og:title" content="Raspberry Piで自然を手元に持ってくる方法について" />
                <meta property="og:url" content="https://nkm3.org/bring_your_own_nature_with_raspberry_pi.html" />
                <meta property="og:description" content="Raspberry Piで自然を手元に持ってくる方法について" />
                    <meta property="article:tag" content="note" />
            <link rel="stylesheet" href="https://nkm3.org/theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://nkm3.org/theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://nkm3.org/theme/css/main.css">

    <link rel="stylesheet" href="https://nkm3.org/theme/css/blog.css">
    <link rel="stylesheet" href="https://nkm3.org/theme/css/github.css">
        <link href="https://nkm3.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="nkm3 Atom Feed" />
        <script src="https://nkm3.org/theme/js/vendor/modernizr-2.6.2.min.js"></script>
        <meta name="google-site-verification" content="DpqlLQbMCcABYeNKp2A06sMQTxLp3Cjn0E4JdR3wLGA" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="https://nkm3.org"><h1><i class="icon-double-angle-right"></i> nkm3</h1></a>
        <p id="site-desc"></p>
    </hgroup>
    <nav>
        <ul id="nav-links">
                <li><a href="https://nkm3.org//pages/about.html">About</a></li>
        </ul>
    </nav>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> and <a href="http://python.org/" target="python">Python</a>. Theme by <a href="https://github.com/hdra/pelican-cait" target="github">hndr</a>.
    </p>
    <p>
        Textures by <a href="http://subtlepatterns.com/" target="subtlepatterns">Subtle Pattern</a>. Font Awesome by <a href="http://fortawesome.github.io/Font-Awesome/" target="github">Dave Grandy</a>.
    </p>
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2021-10-04T00:00:00+09:00" pubdate>
                            2021-10-04
                        </time>
                        <a href="https://nkm3.org/bring_your_own_nature_with_raspberry_pi.html" rel="bookmark"><h1>Raspberry Piで自然を手元に持ってくる方法について</h1></a>
                    </header>

                    <section class="post-content">
                        <h1>Raspberry Piで自然を手元に持ってくる方法について</h1>
<p><img alt="Screen Shot 2021-09-26 at 9.05.02.png" src="https://nkm3.org/images/Screen Shot 2021-09-26 at 9.05.02.png">
映像と音声で都会にいても自然環境を楽しめる仕組みをRaspberry Piとオープンソースのソフトを使って作りました<br>
朝から昼の間の鳥のさえずりから夕方から夜にかけての虫の音まで一日中自然の音を聞くことができて都会での居心地が少しよくなりました  </p>
<h1>仕組み</h1>
<p><img alt="Screen Shot 2021-09-26 at 9.05.02.png" src="https://nkm3.org/images/bring_your_own_nature_with_raspberry_pi.001.png"></p>
<h2>Raspberry Piとクラウドの役割分担</h2>
<ul>
<li>Raspberry Pi(FFmpeg)<ul>
<li>Webカメラから映像と音声をRTMPプロトコルに乗せます</li>
</ul>
</li>
<li>クラウド上の配信サーバー(nginx-rtmp-module)<ul>
<li>RTMPプロトコルで送られて来たストリームを分割します</li>
<li>分割したファイルを並べたプレイリストを更新します</li>
<li>プレイリストと分割したファイルをHTTPで公開します</li>
<li>APIサーバー(bottlepy)<ul>
<li>Raspberry Piからの配信開始、終了時にslack通知します</li>
<li>Raspberry Piからの配信状態を表示します</li>
</ul>
</li>
</ul>
</li>
<li>ブラウザー(hls.js)</li>
</ul>
<h2>使ったソフトウェア、サービスなど</h2>
<h3>撮影部分</h3>
<ul>
<li>Webカメラ<ul>
<li>Logicool C922n</li>
</ul>
</li>
<li>Raspberry Pi<ul>
<li>Raspberry Pi 3 Model A+</li>
</ul>
</li>
<li><a href="https://ffmpeg.org">FFmpeg</a></li>
</ul>
<h3>配信部分</h3>
<ul>
<li><a href="https://github.com/arut/nginx-rtmp-module/">nginx-rtmp-module</a></li>
<li><a href="https://unit.nginx.org">nginx-unit</a></li>
<li><a href="https://bottlepy.org/docs/dev/">bottlepy</a></li>
</ul>
<h3>表示部分</h3>
<ul>
<li><a href="https://github.com/video-dev/hls.js/">hls.js</a></li>
</ul>
<h1>ポイント</h1>
<h2>FFmpegの設定</h2>
<div class="highlight"><pre><span></span><code><span class="nv">ffmpeg</span> \
  <span class="o">-</span><span class="nv">y</span> \
  <span class="o">-</span><span class="nv">f</span> <span class="nv">alsa</span> <span class="o">-</span><span class="nv">ac</span> <span class="mh">$C</span><span class="nv">HANNELS</span> <span class="o">-</span><span class="nv">thread_queue_size</span> <span class="mi">16384</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">15</span> <span class="o">-</span><span class="nv">re</span> <span class="o">-</span><span class="nv">t</span> <span class="mh">$D</span><span class="nv">URATION</span> <span class="o">-</span><span class="nv">i</span> <span class="mh">$A</span><span class="nv">UDIO_DEVICE</span>\
  <span class="o">-</span><span class="nv">f</span> <span class="nv">v4l2</span> <span class="o">-</span><span class="nv">thread_queue_size</span> <span class="mi">16384</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">640</span><span class="nv">x360</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">15</span> <span class="o">-</span><span class="nv">t</span> <span class="mh">$D</span><span class="nv">URATION</span> <span class="o">-</span><span class="nv">i</span> $<span class="nv">VIDEO_DEVICE</span> \
  <span class="o">-</span><span class="nv">c</span>:<span class="nv">a</span> <span class="nv">aac</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">a</span> <span class="mi">128</span><span class="nv">k</span> <span class="o">-</span><span class="nv">ar</span> $<span class="nv">SAMPLING_RATE</span> <span class="o">-</span><span class="nv">bufsize</span> <span class="mi">128</span><span class="nv">k</span> \
  <span class="o">-</span><span class="nv">c</span>:<span class="nv">v</span> <span class="nv">h264_omx</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">v</span> <span class="mi">500</span><span class="nv">k</span> <span class="o">-</span><span class="nv">bufsize</span> <span class="mi">500</span><span class="nv">k</span> <span class="o">-</span><span class="nv">vsync</span> <span class="nv">cfr</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">300</span> <span class="o">-</span><span class="nv">profile</span>:<span class="nv">v</span>:<span class="mi">1</span> <span class="nv">main</span>\
  <span class="o">-</span><span class="nv">bsf</span>:<span class="nv">v</span> <span class="nv">h264_mp4toannexb</span> \
  <span class="o">-</span><span class="nv">flags</span> <span class="o">+</span><span class="nv">cgop</span><span class="o">+</span><span class="k">loop</span><span class="o">+</span><span class="nv">global_header</span> \
  <span class="o">-</span><span class="nv">ignore_unknown</span> \
  <span class="o">-</span><span class="nv">f</span> <span class="nv">flv</span> $<span class="nv">RTMP_SERVER_URL</span>
</code></pre></div>

<p>ちょうど良いオプションがなかなか見つからなかったのですが、いまとのころこのコマンドラインで良さそうな感じがしています</p>
<h2>nginx-rtmp-moduleの設定</h2>
<p>こちらのdocker imageをもとにしました<br>
<a href="https://hub.docker.com/r/tiangolo/nginx-rtmp/">https://hub.docker.com/r/tiangolo/nginx-rtmp/</a><br>
<a href="https://github.com/tiangolo/nginx-rtmp-docker">https://github.com/tiangolo/nginx-rtmp-docker</a></p>
<h3>Dockerfile</h3>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">tiangolo/nginx-rtmp</span>

<span class="k">COPY</span> nginx.conf /etc/nginx/nginx.conf

<span class="k">WORKDIR</span><span class="s"> /html/</span>
<span class="k">COPY</span> index.html /html/index.html
<span class="k">WORKDIR</span><span class="s"> /var/www/html/output</span>

<span class="k">EXPOSE</span><span class="s"> 1935</span>
</code></pre></div>

<h3>nginx.conf</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># https://github.com/tiangolo/nginx-rtmp-docker/issues/18</span>
<span class="n">worker_processes</span> <span class="n">auto</span><span class="p">;</span>
<span class="n">rtmp_auto_push</span> <span class="n">on</span><span class="p">;</span>
<span class="n">events</span> <span class="p">{}</span>
<span class="n">rtmp</span> <span class="p">{</span>
    <span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">1935</span><span class="p">;</span>
        <span class="n">listen</span> <span class="p">[::]:</span><span class="mi">1935</span> <span class="n">ipv6only</span><span class="o">=</span><span class="n">on</span><span class="p">;</span>    
        <span class="n">application</span> <span class="n">live</span> <span class="p">{</span>
            <span class="n">live</span> <span class="n">on</span><span class="p">;</span>
            <span class="n">record</span> <span class="n">off</span><span class="p">;</span>
            <span class="n">notify_method</span> <span class="n">get</span><span class="p">;</span>
            <span class="n">on_publish</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">nginx</span><span class="o">-</span><span class="n">unit</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">app</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">publish_start_hook</span><span class="p">;</span>
            <span class="n">on_publish_done</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">nginx</span><span class="o">-</span><span class="n">unit</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">app</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">publish_end_hook</span><span class="p">;</span>
            <span class="n">hls</span> <span class="n">on</span><span class="p">;</span>
            <span class="n">hls_path</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">output</span><span class="p">;</span>
            <span class="n">hls_fragment</span> <span class="mi">1</span><span class="n">s</span><span class="p">;</span>
            <span class="n">hls_continuous</span> <span class="n">on</span><span class="p">;</span>
            <span class="n">hls_cleanup</span> <span class="n">on</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">http</span> <span class="p">{</span>
    <span class="n">server_tokens</span> <span class="n">off</span><span class="p">;</span>
    <span class="n">include</span> <span class="n">mime</span><span class="o">.</span><span class="n">types</span><span class="p">;</span>
    <span class="n">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
    <span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>      <span class="c1"># HTTP IPv4</span>
        <span class="n">listen</span> <span class="p">[::]:</span><span class="mi">80</span><span class="p">;</span> <span class="c1"># HTTP IPv6</span>
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
            <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">nginx</span><span class="o">-</span><span class="n">unit</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">app</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">/</span><span class="n">output</span> <span class="p">{</span>
            <span class="n">add_header</span> <span class="n">Cache</span><span class="o">-</span><span class="n">Control</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">;</span>
            <span class="n">add_header</span> <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span> <span class="s1">&#39;*&#39;</span> <span class="n">always</span><span class="p">;</span>
            <span class="n">add_header</span> <span class="s1">&#39;Access-Control-Expose-Headers&#39;</span> <span class="s1">&#39;Content-Length&#39;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">$</span><span class="n">request_method</span> <span class="o">=</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">add_header</span> <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
                <span class="n">add_header</span> <span class="s1">&#39;Access-Control-Max-Age&#39;</span> <span class="mi">1728000</span><span class="p">;</span>
                <span class="n">add_header</span> <span class="s1">&#39;Content-Type&#39;</span> <span class="s1">&#39;text/plain charset=UTF-8&#39;</span><span class="p">;</span>
                <span class="n">add_header</span> <span class="s1">&#39;Content-Length&#39;</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">return</span> <span class="mi">204</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">types</span> <span class="p">{</span>
                <span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">mpegurl</span> <span class="n">m3u8</span><span class="p">;</span>
                <span class="n">video</span><span class="o">/</span><span class="n">mp2t</span> <span class="n">ts</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">root</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2>配信サーバーのdocker-composeファイル</h2>
<div class="highlight"><pre><span></span><code><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3.9&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">nginx</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginxproxy</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">proxy</span>
        <span class="n">ports</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;80:80&quot;</span>
        <span class="n">expose</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;80&quot;</span>
        <span class="n">volumes</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;/var/run/docker.sock:/tmp/docker.sock:ro&quot;</span>
    <span class="n">nginx</span><span class="o">-</span><span class="n">rtmp</span><span class="o">-</span><span class="n">module</span><span class="p">:</span>
        <span class="n">build</span><span class="p">:</span> <span class="o">./</span><span class="n">nginx</span><span class="o">-</span><span class="n">rtmp</span><span class="o">-</span><span class="n">module</span>
        <span class="n">ports</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;1935:1935&quot;</span>
        <span class="n">environment</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">VIRTUAL_HOST</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">nkm3</span><span class="o">.</span><span class="n">org</span>
            <span class="o">-</span> <span class="n">VIRTUAL_PORT</span><span class="o">=</span><span class="mi">80</span>
        <span class="n">container_name</span><span class="p">:</span> <span class="n">stream_delivery</span>
    <span class="n">nginx</span><span class="o">-</span><span class="n">unit</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">app</span><span class="p">:</span>
        <span class="n">build</span><span class="p">:</span> <span class="o">./</span><span class="n">nginx</span><span class="o">-</span><span class="n">unit</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">app</span>
        <span class="n">volumes</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;./nginx-unit-stream-control-app/config/:/docker-entrypoint.d/&quot;</span>
            <span class="o">-</span> <span class="s2">&quot;./nginx-unit-stream-control-app/log/unit.log:/var/log/unit.log&quot;</span>
            <span class="o">-</span> <span class="s2">&quot;./nginx-unit-stream-control-app/state/:/var/lib/unit/&quot;</span>
            <span class="o">-</span> <span class="s2">&quot;./nginx-unit-stream-control-app/webapp/:/www/&quot;</span>
        <span class="n">env_file</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">stream</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">app</span><span class="o">.</span><span class="n">env</span>
</code></pre></div>

<p>docker-composeですべて立ち上がるようにしています</p>
<ul>
<li>HTTPリクエストは一旦nginx-proxyで受けます(VIRTUAL HOSTと今後のHTTPS対応をするためです)</li>
<li>indexページとHLSのフラグメントファイルはnginx-rtmp-moduleから配信されます</li>
<li>APIへのリクエストはnginx-unit-stream-control-appから配信されます<ul>
<li>ユーザーからのリクエストはnginx-proxy→nginx-rtmp-module→nginx-unit-stream-control-appと2段階でproxyされます</li>
<li>配信開始、終了のwebhookリクエストはnginx-rtmp-moduleで発生するのでnginx-rtmp-moduleからnginx-unit-stream-control-appに直接リクエストされます</li>
</ul>
</li>
</ul>
<h1>クラウド側のサーバーについて</h1>
<p>クラウド側のサーバーはOracle CloudがAlways freeで提供しているCompute Instance VM.Standard.E2.1.Microを使っています <a href="https://cloud.oracle.com/">Oracle Cloud</a></p>
                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Tags: <a href="https://nkm3.org/tag/note.html">note</a>, </p>
                    </aside>
                    <hr/>
                </article>
            </li>
        </ol>
    </div>
        </div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1928342-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1928342-2');
</script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#000"
    },
    "button": {
      "background": "#ffffff"
    }
  },
  "theme": "edgeless",
  "position": "bottom-left"
});
</script>
        <script src="https://nkm3.org/theme/js/main.js"></script>
    </body>
</html>